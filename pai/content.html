<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>ä¸–èˆˆDMæ–‡æ¡ˆå°å¹«æ‰‹</title>
    
    <meta property="og:title" content="ä¸–èˆˆDMæ–‡æ¡ˆå°å¹«æ‰‹">
    <meta property="og:description" content="æä¾›è¡Œç¨‹å»£å‘Šæ–‡æ¡ˆèˆ‡ç´ æä¸‹è¼‰ã€‚">
    <meta property="og:type" content="website">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        /* æ²¿ç”¨åŸæœ‰é…è‰²èˆ‡é¢¨æ ¼ */
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; }
        .custom-header { background-color: #f37021; padding-top: 10px; padding-bottom: 20px; }
        .header-logo-container { width: 100%; text-align: center; margin-bottom: 10px; padding: 0 15px; }
        .header-logo { width: 100%; max-width: 400px; height: auto; object-fit: contain; }
        .header-title { font-size: 1.5rem; font-weight: bold; color: white; }
        .header-info { color: white; font-size: 0.9rem; line-height: 1.3; text-align: right; }
        
        /* åˆ—è¡¨å¡ç‰‡æ¨£å¼èª¿æ•´ */
        .copy-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            transition: box-shadow 0.2s;
            cursor: pointer;
            height: 100%;
            /* â˜… é—œéµä¿®æ­£ï¼šåŠ ä¸Š position: relative é™åˆ¶ stretched-link çš„ä½œç”¨ç¯„åœ */
            position: relative; 
        }
        .copy-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card-img-wrapper {
            width: 100%;
            height: 250px;
            background-color: #eee;
            position: relative;
            overflow: hidden;
        }
        
        @media (min-width: 768px) {
            .card-img-wrapper {
                height: 100%;
                min-height: 280px; 
            }
        }

        .dm-img-main {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .copy-preview-text {
            display: -webkit-box;
            -webkit-line-clamp: 6;
            -webkit-box-orient: vertical;
            overflow: hidden;
            color: #555;
            font-size: 1rem;
            white-space: pre-wrap; 
            line-height: 1.6;
        }

        /* å½ˆçª—æ¨£å¼ */
        .modal-header { background: #2c3e50; color: white; }
        .modal-title { font-weight: bold; }
        
        .copy-content-box {
            background-color: #f8f9fa;
            border: 1px dashed #ccc;
            padding: 15px;
            border-radius: 5px;
            font-size: 0.95rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        /* ç´ æåœ–ç‰‡æ ¼ç·š */
        .asset-img-container {
            width: 100%;
            aspect-ratio: 4/3;
            background: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            position: relative;
        }
        .asset-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }
        .asset-img:hover {
            transform: scale(1.05);
        }
        
        /* æ¨™ç¤ºåŸåœ–é€£çµçš„ icon (å¯é¸) */
        .asset-link-icon {
            position: absolute;
            bottom: 5px;
            right: 5px;
            color: white;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            padding: 5px;
            font-size: 0.8rem;
            pointer-events: none;
        }

        .dropdown-item { padding: 10px 20px; border-bottom: 1px solid #eee; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background-color: #f8f9fa; color: #f37021; }

        /* é¦–é é¢¨æ ¼æŒ‰éˆ• */
        .home-style-btn {
            display: block;
            width: 100%;
            background-color: #fff;
            color: #dc3545;
            font-weight: bold;
            padding: 12px 0;
            border-radius: 50px;
            text-decoration: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid transparent;
            transition: background-color 0.2s, color 0.2s;
        }
        .home-style-btn:hover {
            background-color: #f8f9fa;
            color: #bd2130;
            border-color: #eee;
        }

    </style>
</head>
<body>

<header class="custom-header shadow-sm mb-4">
    <div class="header-logo-container">
        <img src="../logo.png" alt="æ–°é­…åŠ›æ—…éŠ Logo" class="header-logo" onerror="this.style.display='none';">
    </div>
    
    <div class="container">
        <div class="d-flex justify-content-between align-items-end mb-3">
            <div class="header-title">
                ğŸ“ ä¸–èˆˆDMæ–‡æ¡ˆå°å¹«æ‰‹
            </div>
            
            <div class="header-info d-flex align-items-center">
                <div class="me-2">
                    <div>æ¥­å‹™ï¼šé™³å½¥ç™¾(ç™¾ç™¾)</div>
                    <div>æ‰‹æ©Ÿï¼š0917268665</div>
                </div>
                <a href="https://line.me/ti/p/I_O5--_4ks" target="_blank">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg" alt="LINE" height="36">
                </a>
            </div>
        </div>

        <!-- åŠŸèƒ½æŒ‰éˆ• -->
        <div class="d-flex gap-2">
            <a href="https://0917268665.github.io/DM/pai/maker.html" target="_blank" class="btn btn-light text-danger fw-bold shadow-sm flex-fill py-2" style="border-radius: 50px;">
                âœ¨ é»æˆ‘å‰å¾€è²¼æ¨™ç¥å™¨
            </a>
            <a href="https://0917268665.github.io/DM/pai/" class="btn btn-light text-primary fw-bold shadow-sm flex-fill py-2" style="border-radius: 50px;">
                ğŸ  å›è¡Œç¨‹ä¸‹è¼‰
            </a>
        </div>
    </div>
</header>

<!-- å…§å®¹å€ -->
<div class="container mb-5">
    <div class="row g-4" id="copy-list">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-secondary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">æ­£åœ¨è®€å–æ–‡æ¡ˆè³‡æ–™...</p>
        </div>
    </div>
</div>

<!-- è©³æƒ…å½ˆçª— (Modal) -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="m-title">æ¨™é¡Œ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                
                <!-- æŒ‰éˆ•å€ -->
                <div class="d-flex flex-wrap gap-2 mb-1 justify-content-end" id="m-action-area">
                    <!-- JS å‹•æ…‹ç”ŸæˆæŒ‰éˆ• -->
                </div>
                
                <div class="text-end mb-3">
                    <small class="text-muted" style="font-size: 0.8rem;">(å¦‚éœ€åˆæˆæ‚¨çš„logoåº•æ¨™ï¼Œè«‹å‰å¾€è²¼æ¨™ç¥å™¨)</small>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold mb-0"><i class="bi bi-text-left"></i> å»£å‘Šæ–‡æ¡ˆ</h6>
                    <button class="btn btn-sm btn-dark" onclick="copyText()">
                        <i class="bi bi-clipboard"></i> ä¸€éµè¤‡è£½æ–‡æ¡ˆ
                    </button>
                </div>
                <!-- æ–‡æ¡ˆå€å¡Š -->
                <div class="copy-content-box mb-4" id="m-full-text"></div>

                <hr>

                <!-- ç´ æåœ–ç‰‡å€ -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold mb-0"><i class="bi bi-images"></i> è¡Œç¨‹ç´ æåœ–ç‰‡</h6>
                    <!-- æ‰“åŒ…ä¸‹è¼‰æŒ‰éˆ• (å‹•æ…‹ç”Ÿæˆ) -->
                    <div id="m-zip-btn-container"></div>
                </div>
                
                <div class="row g-3" id="m-assets-container"></div>
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="copyToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        <i class="bi bi-check-circle-fill me-2"></i> æ–‡æ¡ˆå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- å¼•å…¥ JSZip å’Œ FileSaver ç”¨æ–¼æ‰“åŒ…ä¸‹è¼‰ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
    // ================= è¨­å®šå€ =================
    const googleSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTcPCobeix2WBU69fxSbx9IKFJpPtP04dutrcHp-KV8L1vnAEcUErx-x0zfGbBBYaUWtzgR-ZZR6W6B/pub?gid=1046620833&single=true&output=csv";
    // =========================================

    let ALL_DATA = [];

    const listContainer = document.getElementById('copy-list');
    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
    const toast = new bootstrap.Toast(document.getElementById('copyToast'));

    document.addEventListener("DOMContentLoaded", function() {
        fetchData();
    });

    // â˜… è¼”åŠ©å‡½å¼ï¼šå–å¾—æ¬„ä½å…§å®¹
    function getField(item, possibleKeys) {
        for (let key of possibleKeys) {
            if (item[key] !== undefined && item[key] !== "") return item[key];
        }
        const lowerKeys = possibleKeys.map(k => k.toLowerCase());
        for (let objKey in item) {
            if (lowerKeys.includes(objKey.toLowerCase()) && item[objKey] !== "") {
                return item[objKey];
            }
        }
        return null;
    }

    // â˜… å‡½å¼ï¼šè½‰æ›åœ–ç‰‡ç¶²å€ç‚º _m ç‰ˆæœ¬
    function getCompressedImgUrl(url) {
        if (!url) return "";
        // å¦‚æœå·²ç¶“æ˜¯ _m çµå°¾ï¼Œç›´æ¥å›å‚³
        if (url.match(/_m\.(jpg|jpeg|png|gif|webp)$/i)) return url;
        
        // å˜—è©¦å°‡å‰¯æª”åæ›¿æ›ç‚º _m.å‰¯æª”å
        // ä¾‹å¦‚ image.jpg -> image_m.jpg
        return url.replace(/(\.(jpg|jpeg|png|gif|webp))$/i, "_m$1");
    }

    function fetchData() {
        Papa.parse(googleSheetUrl, {
            download: true,
            header: true,
            complete: function(results) {
                ALL_DATA = results.data
                    .map(item => {
                        const content = getField(item, ['content', 'Content', 'æ–‡æ¡ˆ', 'æ–‡æ¡ˆå…§å®¹']);
                        const title = getField(item, ['title', 'Title', 'æ¨™é¡Œ']);
                        const category = getField(item, ['category', 'Category', 'åˆ†é¡']);
                        const dm_img = getField(item, ['dm_img', 'dm', 'DM', 'DMåœ–æª”']);
                        const assetsStr = getField(item, ['assets', 'Assets', 'ç´ æ', 'ç´ æåœ–ç‰‡', 'ç´ æé€£çµ']);

                        if (!title) return null;

                        // è™•ç† Word é€£çµ
                        let docFiles = [];
                        for(let i=1; i<=10; i++){
                            const link = item[`doc_link_${i}`];
                            const name = item[`doc_name_${i}`];
                            if(link && link.trim() !== "") {
                                docFiles.push({
                                    name: name || `è¡Œç¨‹ ${i}`,
                                    url: link.trim()
                                });
                            }
                        }
                        if(docFiles.length === 0 && item.doc_link && item.doc_link.trim() !== "") {
                            docFiles.push({
                                name: "ä¸‹è¼‰è¡Œç¨‹ Word",
                                url: item.doc_link.trim()
                            });
                        }

                        return {
                            ...item, 
                            title: title,
                            content: content,
                            category: category,
                            dm_img: dm_img, // ä¿ç•™åŸåœ– URL (ä¾›ä¸‹è¼‰ç”¨)
                            dm_img_m: getCompressedImgUrl(dm_img), // ç”¢ç”Ÿå£“ç¸®åœ– URL (ä¾›é¡¯ç¤ºç”¨)
                            assetsArray: assetsStr ? assetsStr.split(',').map(url => url.trim()).filter(url => url !== "") : [],
                            docFiles: docFiles
                        };
                    })
                    .filter(item => item !== null);
                
                if (ALL_DATA.length === 0 && results.data.length > 0) {
                     console.warn("ç„¡æ³•è­˜åˆ¥ CSV æ¬„ä½ï¼Œè«‹æª¢æŸ¥ Excel è¡¨é ­ã€‚");
                }

                renderList();
            },
            error: function(err) {
                console.error("Error:", err);
                listContainer.innerHTML = `<div class="col-12 text-center text-danger">è®€å–è³‡æ–™å¤±æ•—</div>`;
            }
        });
    }

    function renderList() {
        listContainer.innerHTML = "";
        if (ALL_DATA.length === 0) {
            listContainer.innerHTML = `<div class="col-12 text-center text-muted py-5">æš«ç„¡è³‡æ–™</div>`;
            return;
        }

        ALL_DATA.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'col-12'; 
            
            // é¡¯ç¤ºæ™‚ä½¿ç”¨ dm_img_m (å£“ç¸®åœ–)ï¼Œè‹¥ç„¡å‰‡é¡¯ç¤º placeholder
            const displayImg = item.dm_img_m || 'https://via.placeholder.com/400x300?text=No+Image';

            div.innerHTML = `
                <div class="copy-card" onclick="openDetail(${index})">
                    <div class="row g-0 h-100">
                        <div class="col-md-4 col-xl-3">
                            <div class="card-img-wrapper">
                                <img src="${displayImg}" class="dm-img-main" alt="${item.title}" loading="lazy" onerror="this.src='${item.dm_img}'">
                            </div>
                        </div>
                        <div class="col-md-8 col-xl-9">
                            <div class="card-body h-100 d-flex flex-column p-4">
                                <div class="mb-2">
                                    <span class="badge bg-primary">${item.category || 'ç²¾é¸'}</span>
                                </div>
                                <h4 class="card-title fw-bold mb-3">${item.title}</h4>
                                <div class="copy-preview-text flex-grow-1 mb-3">
                                    ${item.content || '<span class="text-danger">ï¼ˆç³»çµ±åµæ¸¬ä¸åˆ°æ–‡æ¡ˆï¼‰</span>'}
                                </div>
                                <div class="mt-auto text-end">
                                    <button class="btn btn-outline-secondary stretched-link">
                                        æŸ¥çœ‹å®Œæ•´å…§å®¹ & ä¸‹è¼‰
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            listContainer.appendChild(div);
        });
    }

    function openDetail(index) {
        const item = ALL_DATA[index];
        
        document.getElementById('m-title').innerText = item.title;
        document.getElementById('m-full-text').innerText = item.content || '(ç„¡æ–‡æ¡ˆå…§å®¹)';
        
        const actionArea = document.getElementById('m-action-area');
        actionArea.innerHTML = '';

        // 1. Word ä¸‹è¼‰æŒ‰éˆ•
        if (item.docFiles && item.docFiles.length > 0) {
            if (item.docFiles.length === 1) {
                const file = item.docFiles[0];
                actionArea.innerHTML += `
                    <a href="${file.url}" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-file-word"></i> ä¸‹è¼‰ï½—ord
                    </a>
                `;
            } else {
                let dropdownHtml = `
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-folder-symlink"></i> ä¸‹è¼‰ Word (å…±${item.docFiles.length}ç¨®)
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                `;
                item.docFiles.forEach(file => {
                    dropdownHtml += `
                        <li><a class="dropdown-item" href="${file.url}" target="_blank">
                            <i class="bi bi-file-earmark-word me-2"></i>${file.name}
                        </a></li>
                    `;
                });
                dropdownHtml += `</ul></div>`;
                actionArea.innerHTML += dropdownHtml;
            }
        } else {
             actionArea.innerHTML += `
                <a href="#" class="btn btn-outline-primary btn-sm disabled">
                    <i class="bi bi-file-word"></i> ç„¡è¡Œç¨‹æª”
                </a>
            `;
        }

        // 2. DM ä¸‹è¼‰æŒ‰éˆ• (ä½¿ç”¨åŸåœ– dm_img)
        const dmLink = (item.dm_img && item.dm_img.trim() !== "") ? item.dm_img : "#";
        const dmDisabled = (dmLink === "#") ? "disabled" : "";
        const dmTarget = (dmLink === "#") ? "" : `target="_blank"`;

        actionArea.innerHTML += `
            <a href="${dmLink}" ${dmTarget} class="btn btn-outline-danger btn-sm ${dmDisabled}">
                <i class="bi bi-image"></i> ä¸‹è¼‰DM
            </a>
        `;

        // 3. è²¼æ¨™ç¥å™¨æŒ‰éˆ•
        actionArea.innerHTML += `
            <a href="https://0917268665.github.io/DM/pai/maker.html" target="_blank" class="btn btn-outline-success btn-sm">
                <i class="bi bi-magic"></i> å‰å¾€è²¼æ¨™ç¥å™¨
            </a>
        `;

        // è™•ç†ç´ æåœ–ç‰‡èˆ‡æ‰“åŒ…ä¸‹è¼‰
        const assetContainer = document.getElementById('m-assets-container');
        const zipBtnContainer = document.getElementById('m-zip-btn-container');
        assetContainer.innerHTML = "";
        zipBtnContainer.innerHTML = "";
        
        if (item.assetsArray && item.assetsArray.length > 0) {
            // åŠ å…¥æ‰“åŒ…ä¸‹è¼‰æŒ‰éˆ•
            zipBtnContainer.innerHTML = `
                <button class="btn btn-sm btn-dark" onclick="downloadAllAssets(${index})">
                    <i class="bi bi-file-earmark-zip"></i> ğŸ“¥ ä¸€éµæ‰“åŒ…ä¸‹è¼‰ç´ æ
                </button>
            `;

            item.assetsArray.forEach(imgUrl => {
                // é¡¯ç¤ºåœ–ä½¿ç”¨å£“ç¸®ç‰ˆï¼Œé€£çµä½¿ç”¨åŸåœ–
                const compressedUrl = getCompressedImgUrl(imgUrl);
                
                const col = document.createElement('div');
                col.className = 'col-6'; 
                col.innerHTML = `
                    <div class="asset-img-container">
                        <a href="${imgUrl}" target="_blank">
                            <img src="${compressedUrl}" class="asset-img" loading="lazy" onerror="this.src='${imgUrl}'">
                            <i class="bi bi-zoom-in asset-link-icon"></i>
                        </a>
                    </div>
                `;
                assetContainer.appendChild(col);
            });
        } else {
            assetContainer.innerHTML = '<div class="col-12 text-center text-muted">ç„¡ç´ æåœ–ç‰‡</div>';
        }

        modal.show();
    }

    function copyText() {
        const text = document.getElementById('m-full-text').innerText;
        navigator.clipboard.writeText(text).then(() => {
            toast.show();
        }).catch(err => {
            console.error('è¤‡è£½å¤±æ•—:', err);
            alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
        });
    }

    // æ‰“åŒ…ä¸‹è¼‰åŠŸèƒ½
    async function downloadAllAssets(index) {
        const item = ALL_DATA[index];
        if (!item || !item.assetsArray || item.assetsArray.length === 0) return;

        const btn = document.querySelector('#m-zip-btn-container button');
        const originalText = btn.innerHTML;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> æ‰“åŒ…ä¸­...`;
        btn.disabled = true;

        try {
            const zip = new JSZip();
            const folder = zip.folder("assets");
            
            // ä¸‹è¼‰æ‰€æœ‰åœ–ç‰‡
            const promises = item.assetsArray.map(async (url, i) => {
                try {
                    // å˜—è©¦ fetch åœ–ç‰‡
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const blob = await response.blob();
                    
                    // å–å¾—å‰¯æª”å
                    let ext = "jpg";
                    const match = url.match(/\.(jpg|jpeg|png|gif|webp)$/i);
                    if (match) ext = match[1].replace('.', '');
                    
                    // åŠ å…¥ ZIP
                    const filename = `image_${i + 1}.${ext}`;
                    folder.file(filename, blob);
                } catch (e) {
                    console.error(`ä¸‹è¼‰å¤±æ•—: ${url}`, e);
                    // å¤±æ•—æ™‚ä¸ä¸­æ–·ï¼Œç¹¼çºŒä¸‹è¼‰å…¶ä»–çš„
                }
            });

            await Promise.all(promises);
            
            // ç”¢ç”Ÿä¸¦ä¸‹è¼‰ ZIP
            const content = await zip.generateAsync({ type: "blob" });
            const zipName = `${item.title.substring(0, 10)}_ç´ æåŒ….zip`; // æª”åä½¿ç”¨æ¨™é¡Œå‰10å­—
            saveAs(content, zipName);

        } catch (error) {
            console.error("æ‰“åŒ…éç¨‹ç™¼ç”ŸéŒ¯èª¤:", error);
            alert("æ‰“åŒ…å¤±æ•—ï¼Œå¯èƒ½æ˜¯å› ç‚ºåœ–ç‰‡è·¨ç¶²åŸŸ(CORS)é™åˆ¶ã€‚\nå»ºè­°æ‚¨é»æ“Šå€‹åˆ¥åœ–ç‰‡é€²è¡Œä¸‹è¼‰ã€‚");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

</script>
</body>
</html>